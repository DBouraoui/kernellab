services:
  app:
    image: dbouraoui/kernallab:latest
    networks:
      - internal
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure

  caddy:
    image: caddy:alpine
    networks:
      - public
      - internal
    volumes:
      - ./caddy/prod/Caddyfile:/etc/caddy/Caddyfile
      - ./:/app
    deploy:
      labels:
        - "traefik.enable=true"

        - "traefik.http.routers.kernallab.rule=Host(`myrocket.fr`)"
        - "traefik.http.routers.kernallab.entrypoints=websecure"
        - "traefik.http.routers.kernellab.tls.certresolver=myresolver"
        - "traefik.http.routers.kernallab.service=kernallab-svc"
        - "traefik.http.services.kernallab-svc.loadbalancer.server.port=80"
      replicas: 1

networks:
  public:
    external: true
  internal:
    driver: overlay
    attachable: true
